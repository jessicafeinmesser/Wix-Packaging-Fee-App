var v={};function $(e){let t=globalThis.__wix_context__,n={client:v.client,elevatedClient:v.elevatedClient},o;globalThis.__wix_context__=void 0,v.client=void 0,v.elevatedClient=void 0,typeof $wixContext<"u"&&(o={client:$wixContext==null?void 0:$wixContext.client,elevatedClient:$wixContext==null?void 0:$wixContext.elevatedClient},delete $wixContext.client,delete $wixContext.elevatedClient);try{return e()}finally{globalThis.__wix_context__=t,v.client=n.client,v.elevatedClient=n.elevatedClient,typeof $wixContext<"u"&&($wixContext.client=o.client,$wixContext.elevatedClient=o.elevatedClient)}}var A=Object.defineProperty,R=(e,t,n)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,q=(e,t)=>()=>(e&&(t=e(e=0)),t),J=(e,t)=>{for(var n in t)A(e,n,{get:t[n],enumerable:!0})},b=(e,t,n)=>R(e,typeof t!="symbol"?t+"":t,n),S={};J(S,{EventDefinition:()=>x,SERVICE_PLUGIN_ERROR_TYPE:()=>E,ServicePluginDefinition:()=>W});function x(e,t=!1,n=o=>o){return()=>({__type:"event-definition",type:e,isDomainEvent:t,transformations:n})}function W(e,t){return{__type:"service-plugin-definition",componentType:e,methods:t}}var E,P=q(()=>{E="wix_spi_error"});P();var I=e=>{switch(e){case"get":case"GET":return"GET";case"post":case"POST":return"POST";case"put":case"PUT":return"PUT";case"delete":case"DELETE":return"DELETE";case"patch":case"PATCH":return"PATCH";case"head":case"HEAD":return"HEAD";case"options":case"OPTIONS":return"OPTIONS";default:throw new Error(`Unknown method: ${e}`)}},O=e=>t=>async n=>{let o,r=a=>{if(o=e(n)(a),o.url===void 0)throw new Error("Url was not successfully created for this request, please reach out to support channels for assistance.");let{method:d,url:s,params:c}=o;return{...o,method:I(d),url:s,data:o.data,params:c}};try{let a=await t.request(r);if(o===void 0)throw new Error("Request options were not created for this request, please reach out to support channels for assistance.");let d=Array.isArray(o.transformResponse)?o.transformResponse:[o.transformResponse],s=a.data;return d.forEach(c=>{c&&(s=c(a.data,a.headers))}),s}catch(a){throw typeof a=="object"&&a!==null&&"response"in a&&typeof a.response=="object"&&a.response!==null&&"data"in a.response?a.response.data:a}},H=e=>e.__isAmbassador?!0:!!e().__isAmbassador,U="__metadata",T="www.wixapis.com",D=class extends Error{constructor(e,t){super(e),b(this,"message"),b(this,"response"),this.message=e,this.response=t}async details(){let e=await this.response.json();return k(this.response.status,e==null?void 0:e.message,e==null?void 0:e.details,{requestId:this.response.headers.get("X-Wix-Request-Id"),details:e})}},k=(e,t,n,o)=>({details:{...!(n!=null&&n.validationError)&&{applicationError:{description:t,code:e,data:o}},...n},message:t}),L=e=>e!=null&&e.method&&["post","put","patch"].includes(e.method.toLocaleLowerCase())&&e.body?{"Content-Type":"application/json"}:{},N=e=>e&&typeof e=="object"&&!Array.isArray(e),M=e=>e.__type==="host";function G(e,t){return e.create(t)}var B="x-wix-bi-gateway";function F(e,t,n){return{[B]:V({environment:`js-sdk${n?`-${n}`:""}`,"package-name":e.packageName??(t==null?void 0:t.PACKAGE_NAME),"method-fqn":e.methodFqn,entity:e.entityFqdn})}}function V(e){return Object.entries(e).filter(([t,n])=>!!n).map(([t,n])=>`${t}=${n}`).join(",")}function X(e,t,n,o,r,a,d){return $(()=>e({request:async s=>{var m,i;let c=s({host:(a==null?void 0:a.HTTPHost)||T}),p=c;p.method==="GET"&&((m=p.fallback)!=null&&m.length)&&p.params.toString().length>4e3&&(p=c.fallback[0]);let u=`https://${(a==null?void 0:a.HTTPHost)??T}${p.url}`;p.params&&p.params.toString()&&(u+=`?${p.params.toString()}`);try{let l=F(c,t,d),h=await n(u,{method:p.method,...p.data&&{body:JSON.stringify(p.data)},headers:{...l}});if(h.status!==200){let y=null;try{y=await h.json()}catch{}throw z(h.status,y==null?void 0:y.message,y==null?void 0:y.details,{requestId:h.headers.get("X-Wix-Request-Id"),details:y})}return{data:await h.json(),headers:h.headers,status:h.status,statusText:h.statusText}}catch(l){throw(i=l.message)!=null&&i.includes("fetch is not defined")&&console.error("Node.js v18+ is required"),l}},fetchWithAuth:n,wixAPIFetch:o,getActiveToken:r}))}var z=(e,t,n,o)=>({response:{data:{details:{...!(n!=null&&n.validationError)&&{applicationError:{description:t,code:e,data:o}},...n},message:t},status:e}});P();function j(){return{emit(e,...t){for(let n=0,o=this.events[e]||[],r=o.length;n<r;n++)o[n](...t)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(r=>t!==r)}}}}var K=e=>e.__type==="event-definition";function C(e,t,n,o){let r;if(e.isDomainEvent){let d=n,{deletedEvent:s,actionEvent:c,createdEvent:p,updatedEvent:u,...m}=d,i={...o,...m};s?s!=null&&s.deletedEntity?r={entity:s==null?void 0:s.deletedEntity,metadata:i}:r={metadata:i}:c?r={data:c.body,metadata:i}:r={entity:(p==null?void 0:p.entity)??(u==null?void 0:u.currentEntity),metadata:i}}else r={data:n,metadata:o};let a=e.transformations??(d=>d);return t(a(r))}function Q(e){let t=new Map,n=j(),o={...n,getRegisteredEvents:()=>t,async process(r,a={expectedEvents:[]}){let{eventType:d,identity:s,instanceId:c,payload:p}=await this.parseJWT(r),u=[...a.expectedEvents,...Array.from(t.keys()).map(i=>({type:i}))];if(u.length>0&&!u.some(({type:i})=>i===d))throw new Error(`Unexpected event type: ${d}. Expected one of: ${u.map(i=>i.type).join(", ")}`);let m=t.get(d)??[];return await Promise.all(m.map(({eventDefinition:i,handler:l})=>C(i,l,p,{instanceId:c,identity:s}))),{instanceId:c,eventType:d,payload:p,identity:s}},async processRequest(r,a){let d=await r.text();return this.process(d,a)},async parseJWT(r){if(!e.decodeJWT)throw new Error("decodeJWT is not supported by the authentication strategy");let{decoded:a,valid:d}=await e.decodeJWT(r);if(!d)throw new Error("JWT is not valid");if(typeof a.data!="string")throw new Error(`Unexpected type of JWT data: expected string, got ${typeof a.data}`);let s=JSON.parse(a.data),c=s.eventType,p=s.instanceId,u=s.identity?JSON.parse(s.identity):void 0,m=JSON.parse(s.data);return{instanceId:p,eventType:c,payload:m,identity:u}},async parseRequest(r){let a=await r.text();return this.parseJWT(a)},async executeHandlers(r){let a=Array.from(t.keys()).map(s=>({type:s}));if(a.length>0&&!a.some(({type:s})=>s===r.eventType))throw new Error(`Unexpected event type: ${r.eventType}. Expected one of: ${a.map(s=>s.type).join(", ")}`);let d=t.get(r.eventType)??[];await Promise.all(d.map(({eventDefinition:s,handler:c})=>C(s,c,r.payload,{instanceId:r.instanceId,identity:r.identity})))},apps:{AppInstalled:x("AppInstalled")(),AppRemoved:x("AppRemoved")()}};return{initModule(r){return a=>{let d=t.get(r.type)??[];d.push({eventDefinition:r,handler:a}),t.set(r.type,d),n.emit("registered",r)}},client:o}}var Y=e=>e.__type==="service-plugin-definition";function Z(e){let t=new Map,n=j(),o={...n,getRegisteredServicePlugins:()=>t,async parseJWT(r){if(!e.decodeJWT)throw new Error("decodeJWT is not supported by the authentication strategy");let{decoded:a,valid:d}=await e.decodeJWT(r,!0);if(!d)throw new Error("JWT is not valid");if(typeof a.data!="object"||a.data===null||!("metadata"in a.data)||typeof a.data.metadata!="object"||a.data.metadata===null||!("appExtensionType"in a.data.metadata)||typeof a.data.metadata.appExtensionType!="string")throw new Error("Unexpected JWT data: expected object with metadata.appExtensionType string");return a.data},async process(r){let a=await this.parseJWT(r.body);return this.executeHandler(a,r.url)},async parseRequest(r){let a=await r.text();return this.parseJWT(a)},async processRequest(r){let a=r.url,d=await r.text();try{let s=await this.process({url:a,body:d});return Response.json(s)}catch(s){if(s.errorType==="SPI"&&s.applicationCode&&s.httpCode)return Response.json({applicationError:{code:s.applicationCode,data:s.data}},{status:s.httpCode});throw s}},async executeHandler(r,a){let d=r.metadata.appExtensionType.toLowerCase(),s=t.get(d)??[];if(s.length===0)throw new Error(`No service plugin implementations found for component type ${d}`);if(s.length>1)throw new Error(`Multiple service plugin implementations found for component type ${d}. This is currently not supported`);let{implementation:c,servicePluginDefinition:p}=s[0],u=p.methods.find(i=>a.endsWith(i.primaryHttpMappingPath));if(!u)throw new Error("Unexpect request: request url did not match any method: "+a);let m=c[u.name];if(!m)throw new Error(`Got request for service plugin method ${u.name} but no implementation was provided. Available methods: ${Object.keys(c).join(", ")}`);return u.transformations.toREST(await m(u.transformations.fromREST(r)))}};return{initModule(r){return a=>{let d=t.get(r.componentType.toLowerCase())??[];d.push({servicePluginDefinition:r,implementation:a}),t.set(r.componentType.toLowerCase(),d),n.emit("registered",r)}},client:o}}function ee(e){let t=e.headers||{Authorization:""},n=e.auth||{getAuthHeaders:i=>Promise.resolve({headers:{}})},o=n.getAuthHeaders.bind(void 0,e.host);n.getAuthHeaders=o;let r=async(i,l)=>{if(typeof i=="string"||i instanceof URL)return fetch(i,{...l,headers:{...l==null?void 0:l.headers,...(await o()).headers}});for(let[h,y]of Object.entries((await o()).headers))i.headers.set(h,y);return fetch(i,l)},{client:a,initModule:d}=Z(n),{client:s,initModule:c}=Q(n),p=async(i,l)=>{var f,w;let h=await o(),y=L(l);return fetch(i,{...l,headers:{...y,...t,...h==null?void 0:h.headers,...l==null?void 0:l.headers,...(w=(f=e.host)==null?void 0:f.essentials)==null?void 0:w.passThroughHeaders}})},u=(i,l)=>{var h,y;if(K(i))return c(i);if(Y(i))return d(i);if(M(i)&&e.host)return G(i,e.host);if(typeof i=="function"){if("__type"in i&&i.__type===E)return i;let f=((h=e.host)==null?void 0:h.apiBaseUrl)??T;return X($(()=>H(i))?O(i):i,l??{},p,(w,_)=>{let g=new URL(w,`https://${f}`);return g.host=f,g.protocol="https",p(g.toString(),_)},n.getActiveToken,{HTTPHost:f},(y=e.host)==null?void 0:y.name)}else return N(i)?Object.fromEntries(Object.entries(i).map(([f,w])=>[f,u(w,i[U])])):i},m=i=>{for(let l in i)t[l]=i[l]};return{...e.modules?u(e.modules):{},auth:n,setHeaders:m,use:u,enableContext(i,l={elevated:!1}){i==="global"?globalThis.__wix_context__!=null?l.elevated?globalThis.__wix_context__.elevatedClient=this:globalThis.__wix_context__.client=this:l.elevated?globalThis.__wix_context__={elevatedClient:this}:globalThis.__wix_context__={client:this}:l.elevated?v.elevatedClient=this:v.client=this},fetch:(i,l)=>{var f;let h=((f=e.host)==null?void 0:f.apiBaseUrl)??T,y=new URL(i,`https://${h}`);return y.host=h,y.protocol="https",p(y.toString(),l)},fetchWithAuth:r,async graphql(i,l,h={apiVersion:"alpha"}){var g;let y=((g=e==null?void 0:e.host)==null?void 0:g.apiBaseUrl)??T,f=await p(`https://${y}/graphql/${h.apiVersion}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:i,variables:l})});if(f.status!==200)throw new D(`GraphQL request failed with status ${f.status}`,f);let{data:w,errors:_}=await f.json();return{data:w??{},errors:_}},webhooks:s,servicePlugins:a}}export{ee as _,v as w};
//# sourceMappingURL=chunk-XYIDODIB-kVuyCYlR.js.map
